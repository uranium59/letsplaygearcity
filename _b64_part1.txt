#!/usr/bin/env python
"""Parse GearCity TurnEvents.xml - comprehensive timeline analysis."""

import sys, os
import xml.etree.ElementTree as ET
from collections import defaultdict

if sys.platform == "win32":
    sys.stdout.reconfigure(encoding="utf-8")

XML_PATH = "D:/SteamLibrary/steamapps/common/GearCity/media/Maps/Base City Map/scripts/TurnEvents.xml"


def parse_xml(path):
    if not os.path.isfile(path):
        print(f"ERROR: File not found: {path}")
        sys.exit(1)
    return ET.parse(path).getroot()


def collect_economic_data(root):
    econ_keys = ["buyrate", "gas", "interest", "stockrate", "carprice"]
    attr_map = {"buyrate": "rate", "gas": "rate", "interest": "global",
                "stockrate": "rate", "carprice": "rate"}
    data = {}
    for year_el in root.findall("year"):
        y = int(year_el.get("y"))
        yd = {}
        turns = sorted(year_el.findall("turn"), key=lambda t: int(t.get("t", "0")))
        for turn_el in turns:
            for stag in ["GameEvts", "WorldEvts", "NewsEvts"]:
                sec = turn_el.find(stag)
                if sec is not None:
                    for key in econ_keys:
                        if key not in yd:
                            el = sec.find(key)
                            if el is not None:
                                v = el.get(attr_map[key])
                                if v is not None:
                                    yd[key] = float(v)
            for key in econ_keys:
                if key not in yd:
                    el = turn_el.find(key)
                    if el is not None:
                        v = el.get(attr_map[key])
                        if v is not None:
                            yd[key] = float(v)
        data[y] = yd
    return data


def collect_all_events(root):
    govern, war, news, other = [], [], [], []
    skip = {"buyrate","gas","interest","stockrate","carprice","vehiclepop",
            "office","pensionGrowth","comment","WorldEvts","NewsEvts",
            "GameEvts","turn","year","Evts"}
    for year_el in root.findall("year"):
        y = int(year_el.get("y"))
        for turn_el in year_el.findall("turn"):
            t = int(turn_el.get("t"))
            for el in turn_el.iter():
                tag = el.tag
                if tag == "govern":
                    e = {"year": y, "turn": t}; e.update(el.attrib); govern.append(e)
                elif tag == "war":
                    e = {"year": y, "turn": t}; e.update(el.attrib); war.append(e)
                elif tag == "comment":
                    e = {"year": y, "turn": t}; e.update(el.attrib); news.append(e)
                elif tag not in skip:
                    e = {"year": y, "turn": t, "tag": tag}; e.update(el.attrib); other.append(e)
    return govern, war, news, other


def turn_to_month(t):
    m = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
    i = int(t) - 1
    return m[i] if 0 <= i < 12 else f"T{t}"


def flag_econ(val, key):
    if val is None: return "  "
    if key=="buyrate" and val<0.80: return "!!"
    if key=="buyrate" and val<0.90: return "! "
    if key=="gas" and val>3.0: return "!!"
    if key=="gas" and val>2.0: return "! "
    if key=="interest" and val>1.10: return "!!"
    if key=="interest" and val>1.06: return "! "
    if key=="stockrate" and val<0.80: return "!!"
    if key=="stockrate" and val<0.90: return "! "
    if key=="carprice" and val>2.0: return "!!"
    if key=="carprice" and val>1.6: return "! "
    return "  "
